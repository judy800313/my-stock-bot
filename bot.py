import yfinance as yf
import requests
import os
import time

# 1. å¾ä¿éšªç®±æ‹¿é‘°åŒ™
line_token = os.environ['LINE_TOKEN']
user_id = os.environ['USER_ID']

def get_tw_top_200():
    """
    é€™è£¡åˆ—å‡ºå°ç£å¸‚å€¼å‰ 200 å¤§çš„ä¸»è¦ç†±é–€è‚¡èˆ‡æˆåˆ†è‚¡ä»£è™Ÿ
    (æ¶µè“‹ 0050, 0051 åŠä¸»è¦ç”¢æ¥­é¾é ­)
    """
    # é€™è£¡é çµ„äº†ä¸€ä»½å°ç£ç´„ 200 æª”æ ¸å¿ƒæ¬Šå€¼è‚¡æ¸…å–®
    stocks = [
        "2330","2317","2454","2308","2412","2881","2882","2303","2891","3711",
        "2886","1301","1303","2408","1216","2884","2892","2002","2382","2885",
        "2357","2912","1326","2880","3008","2603","2883","2887","2379","5880",
        "2327","2207","2345","3045","2409","2609","3231","2356","4938","2890",
        "1101","1504","4904","2615","2474","2801","1402","2395","6505","9904",
        "1102","2301","5871","2352","1605","1304","2105","2610","2618","9910",
        "2383","2451","2377","2353","2324","3037","3034","2313","2360","6669",
        "8046","6415","3035","3443","2376","2449","2337","2458","3406","6176",
        "6239","3017","3532","3044","2385","2492","6213","2439","4919","3533",
        "5434","2404","6271","2354","2355","3019","8215","2368","3006","6139",
        "2809","2812","2834","2845","2855","5876","6005","2851","2838","2867",
        "1513","1514","1519","1503","1511","1722","1717","1723","1710","1708",
        "2103","2106","2108","9921","9914","9945","9933","9917","9925","8464",
        "2633","2606","2617","2605","2201","2204","2206","1312","1313","1314",
        "1305","1308","1309","1310","1434","1440","1476","1477","1210","1227",
        "1232","1231","1702","1707","1720","4142","1760","3702","3704","3706",
        "2401","2421","2457","2471","2480","2481","3014","3023","3029","3042",
        "3062","3189","3376","3576","3596","3653","3661","4958","4961","5269",
        "6205","6206","6285","6409","6412","6531","6533","8016","8150","2006",
        "2014","2023","2027","2031","2501","2511","2542","5522","2548","9930"
    ]
    return [s + ".TW" for s in stocks]

def check_stock_and_notify():
    stock_list = get_tw_top_200()
    hit_stocks = []
    count = 0

    print(f"ğŸš€ é–‹å§‹å…¨è‡ªå‹•æƒæå°ç£å‰ 200 æ¬Šå€¼è‚¡...")

    for symbol in stock_list:
        count += 1
        try:
            stock = yf.Ticker(symbol)
            # æŠ“å– 1 å¹´æ­·å²è³‡æ–™ä¾†åˆ¤å®š
            df = stock.history(period="1y")
            
            if len(df) < 20: continue

            current_price = df['Close'].iloc[-1]
            # å–å¾—ã€Œé™¤äº†ä»Šå¤©ä»¥å¤–ã€çš„ä¸€å¹´å…§æœ€é«˜åƒ¹
            history_high = df['High'].iloc[:-1].max()

            # åˆ¤æ–·å‰µæ–°é«˜
            if current_price >= history_high:
                magic_number = current_price * 0.764
                hit_stocks.append(f"ğŸ“ˆ {symbol} ({current_price:.1f})\n   ğŸ¯ 0.764: {magic_number:.1f}")
            
            # æ¯æŠ“ 10 æª”ä¼‘æ¯ 1 ç§’ï¼Œé¿å…è¢« Yahoo é– IP
            if count % 10 == 0:
                time.sleep(1)
                
        except Exception as e:
            print(f"âŒ {symbol} ç™¼ç”ŸéŒ¯èª¤: {e}")

    # 3. æ•´ç†è¨Šæ¯
    if hit_stocks:
        # åˆ†æ‰¹ç™¼é€ï¼Œé¿å…ä¸€å‰‡è¨Šæ¯å¤ªé•·è¢« LINE æ“‹æ‰
        header = f"ğŸŒŸã€ä»Šæ—¥å°è‚¡å‰µæ–°é«˜åå–®ã€‘\n(å…±æƒæ {len(stock_list)} æª”)\n"
        full_msg = header + "\n".join(hit_stocks)
        
        # å¦‚æœç¬¦åˆçš„è‚¡ç¥¨å¤ªå¤š(è¶…é 20 æª”)ï¼ŒLINE ä¸€å‰‡è¨Šæ¯æœƒå¡ä¸ä¸‹ï¼Œé€™è£¡åšå€‹ç°¡å–®åˆ‡å‰²
        send_to_line(full_msg[:2000]) # LINE å–®å‰‡ä¸Šé™ç´„ 5000 å­—ï¼Œ2000 å¾ˆå®‰å…¨
    else:
        send_to_line("ä»Šæ—¥æƒæå®Œæˆï¼Œå‰ 200 æª”æ¬Šå€¼è‚¡ä¸­ç„¡äººå‰µæ–°é«˜ã€‚")

def send_to_line(message):
    headers = {"Authorization": f"Bearer {line_token}", "Content-Type": "application/json"}
    payload = {"to": user_id, "messages": [{"type": "text", "text": message}]}
    r = requests.post("https://api.line.me/v2/bot/message/push", headers=headers, json=payload)
    print(f"LINE å‚³é€ç‹€æ…‹: {r.status_code}")

if __name__ == "__main__":
    check_stock_and_notify()
