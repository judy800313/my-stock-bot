import pandas as pd
import requests
import os
import sys
import time

# è®€å– Secrets
LINE_TOKEN = os.getenv('LINE_TOKEN')
USER_ID = os.getenv('USER_ID')
FINMIND_TOKEN = os.getenv('FINMIND_TOKEN')

def send_line(msg):
    if not LINE_TOKEN or not USER_ID: return
    url = "https://api.line.me/v2/bot/message/push"
    headers = {"Authorization": f"Bearer {LINE_TOKEN}", "Content-Type": "application/json"}
    payload = {"to": USER_ID, "messages": [{"type": "text", "text": msg}]}
    try:
        requests.post(url, headers=headers, json=payload, timeout=15)
    except: pass

def get_stock_data(stock_id):
    url = "https://api.finmindtrade.com/api/v4/data"
    start_date = (pd.Timestamp.now() - pd.Timedelta(days=30)).strftime('%Y-%m-%d')
    parameter = {
        "dataset": "TaiwanStockPrice",
        "data_id": stock_id,
        "token": FINMIND_TOKEN,
        "start_date": start_date
    }
    try:
        r = requests.get(url, params=parameter, timeout=15)
        data = r.json()
        if data.get('msg') == 'success' and data.get('data'):
            return pd.DataFrame(data['data'])
    except: pass
    return pd.DataFrame()

def get_stock_dict():
    """320 æª”ä»£ç¢¼èˆ‡ä¸­æ–‡åç¨±å°ç…§è¡¨ (å·²å‰”é™¤é‡‘èè‚¡)"""
    return {
        # ç¬¬ä¸€çµ„ (1-80)
        "1101": "å°æ³¥", "1102": "äºæ³¥", "1103": "å˜‰æ³¥", "1210": "å¤§æˆ", "1216": "çµ±ä¸€",
        "1301": "å°å¡‘", "1303": "å—äº", "1304": "å°èš", "1305": "è¯å¤", "1308": "äºèš",
        "1310": "å°è‹¯", "1312": "åœ‹å–¬", "1314": "ä¸­çŸ³åŒ–", "1319": "æ±é™½", "1326": "å°åŒ–",
        "1402": "é æ±æ–°", "1434": "ç¦æ‡‹", "1440": "å—ç´¡", "1444": "åŠ›éº—", "1476": "å„’é´»",
        "1477": "èšé™½", "1503": "å£«é›»", "1504": "æ±å…ƒ", "1513": "ä¸­èˆˆé›»", "1514": "äºåŠ›",
        "1519": "è¯åŸ", "1522": "å ¤ç¶­è¥¿", "1536": "å’Œå¤§", "1560": "ä¸­ç ‚", "1590": "äºå¾·å®¢",
        "1605": "è¯æ–°", "1608": "è¯æ¦®", "1609": "å¤§äº", "1611": "ä¸­é›»", "1701": "ä¸­åŒ–",
        "1702": "å—åƒ‘", "1707": "è‘¡è„ç‹", "1708": "æ±é¹¼", "1710": "æ±è¯", "1711": "æ°¸å…‰",
        "1712": "èˆˆè¾²", "1717": "é•·èˆˆ", "1720": "ç”Ÿé”", "1722": "å°è‚¥", "1723": "ä¸­ç¢³",
        "1726": "æ°¸è¨˜", "1736": "å–¬å±±", "1760": "å¯¶é½¡å¯ŒéŒ¦", "1762": "ä¸­åŒ–ç”Ÿ", "1795": "ç¾æ™‚",
        "1802": "å°ç»", "1806": "å† è»", "1904": "æ­£éš†", "1907": "æ°¸è±é¤˜", "1909": "æ¦®æˆ",
        "2002": "ä¸­é‹¼", "2006": "æ±å’Œé‹¼éµ", "2014": "ä¸­é´»", "2023": "ç‡è¼", "2027": "å¤§æˆé‹¼",
        "2031": "æ–°å…‰é‹¼", "2034": "å…å¼·", "2101": "å—æ¸¯", "2103": "å°æ©¡", "2105": "æ­£æ–°",
        "2106": "å»ºå¤§", "2108": "å—å¸", "2201": "è£•éš†", "2204": "ä¸­è¯", "2206": "ä¸‰é™½å·¥æ¥­",
        "2231": "ç‚ºå‡", "2301": "å…‰å¯¶ç§‘", "2303": "è¯é›»", "2308": "å°é”é›»", "2312": "é‡‘å¯¶",
        "2313": "è¯é€š", "2317": "é´»æµ·", "2323": "ä¸­ç’°", "2324": "ä»å¯¶", "2327": "åœ‹å·¨",

        # ç¬¬äºŒçµ„ (81-160)
        "2330": "å°ç©é›»", "2337": "æ—ºå®", "2338": "å…‰ç½©", "2344": "è¯é‚¦é›»", "2345": "æ™ºé‚¦",
        "2347": "è¯å¼·", "2351": "é †å¾·", "2352": "ä½³ä¸–é”", "2353": "å®ç¢", "2354": "é´»æº–",
        "2355": "æ•¬éµ¬", "2356": "è‹±æ¥­é”", "2357": "è¯ç¢©", "2360": "è‡´èŒ‚", "2367": "ç‡¿è¯",
        "2368": "é‡‘åƒé›»", "2371": "å¤§åŒ", "2376": "æŠ€å˜‰", "2377": "å¾®æ˜Ÿ", "2379": "ç‘æ˜±",
        "2382": "å»£é”", "2383": "å°å…‰é›»", "2385": "ç¾¤å…‰", "2392": "æ­£å´´", "2393": "å„„å…‰",
        "2401": "å‡Œé™½", "2402": "æ¯…å˜‰", "2404": "æ¼¢å”", "2408": "å—äºç§‘", "2409": "å‹é”",
        "2412": "ä¸­è¯é›»", "2419": "ä»²ç¦", "2421": "å»ºæº–", "2439": "ç¾å¾‹", "2449": "äº¬å…ƒé›»å­",
        "2451": "å‰µè¦‹", "2454": "è¯ç™¼ç§‘", "2455": "å…¨æ–°", "2457": "é£›å®", "2458": "ç¾©éš†",
        "2474": "å¯æˆ", "2480": "æ•¦é™½ç§‘", "2481": "å¼·èŒ‚", "2492": "è¯æ–°ç§‘", "2498": "å®é”é›»",
        "2501": "åœ‹å»º", "2504": "åœ‹ç”¢", "2511": "å¤ªå­", "2515": "ä¸­å·¥", "2520": "å† å¾·",
        "2542": "èˆˆå¯Œç™¼", "2548": "è¯å›º", "2603": "é•·æ¦®", "2605": "æ–°èˆˆ", "2606": "è£•æ°‘",
        "2607": "æ¦®é‹", "2609": "é™½æ˜", "2610": "è¯èˆª", "2615": "è¬æµ·", "2618": "é•·æ¦®èˆª",
        "2633": "å°ç£é«˜éµ", "2634": "æ¼¢ç¿”", "2636": "å°é©ŠæŠ•æ§", "2637": "æ…§æ´‹-KY", "2707": "æ™¶è¯",
        "2723": "ç¾é£Ÿ-KY", "2727": "ç‹å“", "2731": "é›„ç…", "2903": "é ç™¾", "2912": "çµ±ä¸€è¶…",
        "3003": "å¥å’Œèˆˆ", "3005": "ç¥åŸº", "3006": "å°é”", "3008": "å¤§ç«‹å…‰", "3014": "è¯é™½",
        "3017": "å¥‡é‹", "3023": "ä¿¡é‚¦", "3030": "å¾·å¾‹", "3034": "è¯è© ", "3035": "æ™ºåŸ",

        # ç¬¬ä¸‰çµ„ (161-240)
        "3036": "æ–‡æ›„", "3037": "æ¬£èˆˆ", "3042": "æ™¶æŠ€", "3044": "å¥é¼", "3045": "å°ç£å¤§",
        "3130": "ä¸€é›¶å››", "3189": "æ™¯ç¢©", "3227": "åŸç›¸", "3231": "ç·¯å‰µ", "3293": "éˆŠè±¡",
        "3305": "æ˜‡è²¿", "3321": "åŒæ³°", "3376": "æ–°æ—¥èˆˆ", "3406": "ç‰æ™¶å…‰", "3413": "äº¬é¼",
        "3443": "å‰µæ„", "3481": "ç¾¤å‰µ", "3515": "è¯æ“", "3532": "å°å‹ç§‘", "3533": "å˜‰æ¾¤",
        "3557": "å˜‰å¨", "3583": "è¾›è€˜", "3588": "é€šå˜‰", "3596": "æ™ºæ˜“", "3653": "å¥ç­–",
        "3661": "ä¸–èŠ¯-KY", "3665": "è²¿è¯-KY", "3673": "TPK-KY", "3682": "äºå¤ªé›»", "3702": "å¤§è¯å¤§",
        "3704": "åˆå‹¤æ§", "3706": "ç¥é”", "3708": "ä¸Šç·¯æŠ•æ§", "3711": "æ—¥æœˆå…‰æŠ•æ§", "3714": "å¯Œé‡‡",
        "4142": "åœ‹å…‰ç”Ÿ", "4739": "åº·æ™®", "4904": "é å‚³", "4906": "æ­£æ–‡", "4915": "è‡´ä¼¸",
        "4919": "æ–°å”", "4927": "æ³°é¼-KY", "4935": "èŒ‚æ—-KY", "4938": "å’Œç¢©", "4958": "è‡»é¼-KY",
        "4961": "å¤©éˆº", "4967": "åéŠ“", "4968": "ç«‹ç©", "5234": "é”èˆˆææ–™", "5243": "ä¹™ç››-KY",
        "5269": "ç¥¥ç¢©", "5274": "ä¿¡é©Š", "5285": "ç•Œéœ–", "5288": "è±ç¥¥-KY", "5388": "ä¸­ç£Š",
        "5434": "å´‡è¶Š", "5469": "ç€šå®‡åš", "5483": "ä¸­ç¾æ™¶", "6116": "å½©æ™¶", "6139": "äºç¿”",
        "6153": "å˜‰è¯ç›Š", "6176": "ç‘å„€", "6202": "ç››ç¾¤", "6205": "è©®æ¬£", "6206": "é£›æ·",
        "6213": "è¯èŒ‚", "6230": "è¶…çœ¾", "6235": "è¯é›»ç¶²", "6239": "åŠ›æˆ", "6257": "çŸ½æ ¼",
        "6269": "å°éƒ¡", "6271": "åŒæ¬£é›»", "6277": "å®æ­£", "6278": "å°è¡¨ç§‘", "6285": "å•Ÿç¢",
        "6405": "æ‚…åŸ", "6409": "æ—­éš¼", "6412": "æ¨ºæ¼¢", "6415": "çŸ½åŠ›*-KY",

        # ç¬¬å››çµ„ (241-320)
        "6446": "è—¥è¯è—¥", "6472": "ä¿ç‘", "6488": "ç’°çƒæ™¶", "6505": "å°å¡‘åŒ–", "6510": "ç²¾æ¸¬",
        "6515": "ç©å´´", "6531": "æ„›æ™®*", "6533": "æ™¶å¿ƒç§‘", "6643": "M31", "6669": "ç·¯ç©",
        "6670": "å¾©ç››æ‡‰ç”¨", "6719": "åŠ›æ™º", "6770": "åŠ›ç©é›»", "6781": "AES-KY", "8016": "çŸ½å‰µ",
        "8021": "å°–é»", "8039": "å°è™¹", "8046": "å—é›»", "8069": "å…ƒå¤ª", "8081": "è‡´æ–°",
        "8150": "å—èŒ‚", "8210": "å‹¤èª ", "8213": "å¿—è¶…", "8215": "æ˜åŸºæ", "8261": "å¯Œé¼",
        "8299": "ç¾¤è¯", "8454": "å¯Œé‚¦åª’", "8464": "å„„è±", "8936": "åœ‹çµ±", "9802": "éˆºé½Š-KY",
        "9904": "å¯¶æˆ", "9910": "è±æ³°", "9911": "æ«»èŠ±", "9914": "ç¾åˆ©é”", "9917": "ä¸­ä¿ç§‘",
        "9921": "å·¨å¤§", "9930": "ä¸­è¯è³‡æº", "9933": "ä¸­é¼", "9938": "ç™¾å’Œ", "9941": "è£•è",
        "9945": "æ½¤æ³°æ–°", "9958": "ä¸–ç´€é‹¼", "3529": "åŠ›æ—º", "4147": "é¾ç‡ˆ-KY", "4746": "å°è€€",
        "4966": "è­œç‘-KY", "5289": "å®œé¼", "6147": "ç´˜åº·", "6182": "åˆæ™¶", "6411": "æ™¶ç„±",
        "6462": "ç¥ç›¾", "6548": "æµ·å¾·å¨", "6684": "å®‰æ ¼", "8054": "å®‰åœ‹", "8255": "æœ‹ç¨‹",
        "3105": "ç©©æ‡‹", "3141": "æ™¶å®", "3211": "é †é”", "3264": "æ¬£éŠ“", "3324": "é›™é´»",
        "3527": "èšç©", "3611": "é¼ç¿°", "3680": "å®¶ç™»", "4105": "æ±æ´‹", "4123": "æ™Ÿå¾·",
        "4128": "ä¸­å¤©", "4162": "æ™ºæ“", "4728": "é›™ç¾", "4908": "å‰é¼", "4977": "çœ¾é”-KY",
        "5299": "æ°åŠ›", "5347": "ä¸–ç•Œ", "6121": "æ–°æ™®", "6146": "è€•èˆˆ", "6188": "å»£æ˜",
        "6223": "æ—ºçŸ½", "6243": "è¿…å¾·", "6244": "èŒ‚è¿ª", "6274": "å°ç‡¿", "6417": "è–æš‰*"
    }

def main():
    stock_dict = get_stock_dict()
    all_keys = list(stock_dict.keys())

    try:
        group_idx = int(sys.argv[1])
    except:
        group_idx = 1

    # é—œéµæ”¹å‹•ï¼šæ¯çµ„ 80 æª”
    size = 80 
    start = (group_idx - 1) * size
    end = group_idx * size
    target_keys = all_keys[start:end]
    
    if not target_keys: return

    print(f"ğŸš€ FinMind æƒæï¼šç¬¬ {group_idx} çµ„ (å…± {len(target_keys)} æª”)")
    send_line(f"ğŸ¤– æ­£åœ¨åŸ·è¡Œç¬¬ {group_idx} çµ„æƒæ (ç¬¬ {start+1}~{min(end, 320)} æª”)...")

    hit_list = []
    for s in target_keys:
        try:
            df = get_stock_data(s)
            if df.empty or len(df) < 10: continue
            
            curr = df['close'].iloc[-1]
            past_high = df['max'].iloc[-8:-1].max()
            
            if curr >= past_high:
                name = stock_dict.get(s, "")
                # é€™è£¡åŠ å…¥äº†å…©æ¬¡æ›è¡Œ \n\n è®“æ¯è‚¡è³‡è¨Šåˆ†é–‹
                hit_list.append(f"âœ… {s} {name}: {curr:.2f}\nğŸ¯ æ”¯æ’: {curr*0.764:.2f}\n")
            
            time.sleep(0.4) # ä¿è­· API
        except: continue

    if hit_list:
        send_line(f"ğŸš©ã€ç¬¬ {group_idx} çµ„ç¯©é¸å ±å‘Šã€‘\n\n" + "\n".join(hit_list))
    else:
        send_line(f"ğŸ’¡ ç¬¬ {group_idx} çµ„å®Œæˆï¼Œç›®å‰ç„¡æ¨™çš„ã€‚")

if __name__ == "__main__":
    main()
