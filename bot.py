import pandas as pd
import requests
import os
import sys
import time

# å¾ GitHub Secrets è®€å–è¨­å®š
LINE_TOKEN = os.getenv('LINE_TOKEN')
USER_ID = os.getenv('USER_ID')
FINMIND_TOKEN = os.getenv('FINMIND_TOKEN')

def send_line(msg):
    if not LINE_TOKEN or not USER_ID: return
    url = "https://api.line.me/v2/bot/message/push"
    headers = {"Authorization": f"Bearer {LINE_TOKEN}", "Content-Type": "application/json"}
    payload = {"to": USER_ID, "messages": [{"type": "text", "text": msg}]}
    try:
        requests.post(url, headers=headers, json=payload, timeout=10)
    except: pass

def get_stock_data(stock_id):
    url = "https://api.finmindtrade.com/api/v4/data"
    start_date = (pd.Timestamp.now() - pd.Timedelta(days=30)).strftime('%Y-%m-%d')
    parameter = {
        "dataset": "TaiwanStockPrice",
        "data_id": stock_id,
        "start_date": start_date,
        "token": FINMIND_TOKEN,
    }
    try:
        r = requests.get(url, params=parameter, timeout=15)
        data = r.json()
        if data.get('msg') == 'success' and data.get('data'):
            return pd.DataFrame(data['data'])
    except: pass
    return pd.DataFrame()

def get_stock_dict():
    """å®Œæ•´ 200 æª”ä»£ç¢¼èˆ‡ä¸­æ–‡åç¨±å°ç…§è¡¨"""
    return {
        "1101": "å°æ³¥", "1102": "äºæ³¥", "1103": "å˜‰æ³¥", "1210": "å¤§æˆ", "1216": "çµ±ä¸€",
        "1301": "å°å¡‘", "1303": "å—äº", "1304": "å°èš", "1305": "è¯å¤", "1308": "äºèš",
        "1310": "å°è‹¯", "1312": "åœ‹å–¬", "1314": "ä¸­çŸ³åŒ–", "1319": "æ±é™½", "1326": "å°åŒ–",
        "1402": "é æ±æ–°", "1434": "ç¦æ‡‹", "1440": "å—ç´¡", "1444": "åŠ›éº—", "1476": "å„’é´»",
        "1477": "èšé™½", "1503": "å£«é›»", "1504": "æ±å…ƒ", "1513": "ä¸­èˆˆé›»", "1514": "äºåŠ›",
        "1519": "è¯åŸ", "1522": "å ¤ç¶­è¥¿", "1536": "å’Œå¤§", "1560": "ä¸­ç ‚", "1590": "äºå¾·å®¢",
        "1605": "è¯æ–°", "1707": "è‘¡è„ç‹", "1710": "æ±è¯", "1711": "æ°¸å…‰", "1717": "é•·èˆˆ",
        "1720": "ç”Ÿé”", "1722": "å°è‚¥", "1723": "ä¸­ç¢³", "1802": "å°ç»", "1904": "æ­£éš†",
        "2002": "ä¸­é‹¼", "2006": "æ±å’Œé‹¼éµ", "2014": "ä¸­é´»", "2023": "ç‡è¼", "2027": "å¤§æˆé‹¼",
        "2101": "å—æ¸¯", "2103": "å°æ©¡", "2105": "æ­£æ–°", "2106": "å»ºå¤§", "2201": "è£•éš†",
        "2204": "ä¸­è¯", "2206": "ä¸‰é™½å·¥æ¥­", "2301": "å…‰å¯¶ç§‘", "2303": "è¯é›»", "2308": "å°é”é›»",
        "2312": "é‡‘å¯¶", "2313": "è¯é€š", "2317": "é´»æµ·", "2323": "ä¸­ç’°", "2324": "ä»å¯¶",
        "2330": "å°ç©é›»", "2337": "æ—ºå®", "2340": "å…‰ç£Š", "2344": "è¯é‚¦é›»", "2345": "æ™ºé‚¦",
        "2347": "è¯å¼·", "2351": "é †å¾·", "2352": "ä½³ä¸–é”", "2353": "å®ç¢", "2354": "é´»æº–",
        "2355": "æ•¬éµ¬", "2356": "è‹±æ¥­é”", "2357": "è¯ç¢©", "2360": "è‡´èŒ‚", "2367": "ç‡¿è¯",
        "2368": "é‡‘åƒé›»", "2371": "å¤§åŒ", "2376": "æŠ€å˜‰", "2377": "å¾®æ˜Ÿ", "2379": "ç‘æ˜±",
        "2382": "å»£é”", "2383": "å°å…‰é›»", "2385": "ç¾¤å…‰", "2392": "æ­£å´´", "2393": "å„„å…‰",
        "2401": "å‡Œé™½", "2404": "æ¼¢å”", "2408": "å—äºç§‘", "2409": "å‹é”", "2412": "ä¸­è¯é›»",
        "2419": "ä»²ç¦", "2421": "å»ºæº–", "2439": "ç¾å¾‹", "2449": "äº¬å…ƒé›»å­", "2451": "å‰µè¦‹",
        "2454": "è¯ç™¼ç§‘", "2455": "å…¨æ–°", "2458": "ç¾©éš†", "2474": "å¯æˆ", "2480": "æ•¦é™½ç§‘",
        "2492": "è¯æ–°ç§‘", "2498": "å®é”é›»", "2501": "åœ‹å»º", "2504": "åœ‹ç”¢", "2511": "å¤ªå­",
        "2542": "èˆˆå¯Œç™¼", "2548": "è¯å›º", "2603": "é•·æ¦®", "2605": "æ–°èˆˆ", "2606": "è£•æ°‘",
        "2607": "æ¦®é‹", "2609": "é™½æ˜", "2610": "è¯èˆª", "2615": "è¬æµ·", "2618": "é•·æ¦®èˆª",
        "2633": "å°ç£é«˜éµ", "2634": "æ¼¢ç¿”", "2637": "æ…§æ´‹-KY", "2707": "æ™¶è¯", "2723": "ç¾é£Ÿ-KY",
        "2727": "ç‹å“", "2801": "å½°éŠ€", "2809": "äº¬åŸéŠ€", "2812": "å°ä¸­éŠ€", "2834": "è‡ºä¼éŠ€",
        "2880": "è¯å—é‡‘", "2881": "å¯Œé‚¦é‡‘", "2882": "åœ‹æ³°é‡‘", "2883": "é–‹ç™¼é‡‘", "2884": "ç‰å±±é‡‘",
        "2885": "å…ƒå¤§é‡‘", "2886": "å…†è±é‡‘", "2887": "å°æ–°é‡‘", "2888": "æ–°å…‰é‡‘", "2889": "åœ‹ç¥¨é‡‘",
        "2890": "æ°¸è±é‡‘", "2891": "ä¸­ä¿¡é‡‘", "2892": "ç¬¬ä¸€é‡‘", "2897": "ç‹é“éŠ€", "2903": "é ç™¾",
        "2912": "çµ±ä¸€è¶…", "3006": "å£“åŠ›", "3008": "å¤§ç«‹å…‰", "3017": "å¥‡é‹", "3023": "ä¿¡é‚¦",
        "3034": "è¯è© ", "3035": "æ™ºåŸ", "3036": "æ–‡æ›„", "3037": "æ¬£èˆˆ", "3044": "å¥é¼",
        "3189": "æ™¯ç¢©", "3227": "åŸç›¸", "3231": "ç·¯å‰µ", "3406": "ç‰æ™¶å…‰", "3443": "å‰µæ„",
        "3481": "ç¾¤å‰µ", "3532": "å°å‹ç§‘", "3533": "å˜‰æ¾¤", "3583": "è¾›è€˜", "3653": "å¥ç­–",
        "3661": "ä¸–èŠ¯-KY", "3711": "æ—¥æœˆå…‰æŠ•æ§", "4739": "åº·æ™®", "4919": "æ–°å”", "4938": "å’Œç¢©",
        "4958": "è‡»é¼-KY", "4961": "å¤©éˆº", "4967": "åéŠ“", "4968": "ç«‹ç©", "5234": "é”èˆˆææ–™",
        "5269": "ç¥¥ç¢©", "5274": "ä¿¡é©Š", "5871": "ä¸­ç§Ÿ-KY", "5876": "ä¸Šæµ·å•†éŠ€", "5880": "åˆåº«é‡‘",
        "6005": "ç¾¤ç›Šè­‰", "6176": "ç‘å„€", "6205": "è©®æ¬£", "6213": "è¯èŒ‚", "6239": "åŠ›æˆ",
        "6271": "åŒæ¬£é›»", "6414": "æ¨ºæ¼¢", "6415": "çŸ½åŠ›*-KY", "6446": "è—¥è¯è—¥", "6472": "ä¿ç‘",
        "6505": "å°å¡‘åŒ–", "6510": "ç²¾æ¸¬", "6515": "ç©å´´", "6531": "æ„›æ™®*", "6533": "æ™¶å¿ƒç§‘",
        "6643": "M31", "6669": "ç·¯ç©", "9904": "å¯¶æˆ", "9910": "è±æ³°", "9914": "ç¾åˆ©é”",
        "9917": "ä¸­ä¿ç§‘", "9921": "å·¨å¤§", "9933": "ä¸­é¼", "9941": "è£•è", "9945": "æ½¤æ³°æ–°"
    }

def main():
    stock_dict = get_stock_dict()
    # è‡ªå‹•å°‡å°ç…§è¡¨çš„ Key è½‰ç‚ºæƒææ¸…å–®ï¼Œä¸¦æŒ‰ä»£ç¢¼æ’åº
    all_list = sorted(list(stock_dict.keys()))

    try:
        group_idx = int(sys.argv[1])
    except:
        group_idx = 1

    size = 40 # æ¯çµ„æ”¹ç‚º 40 æª”ï¼Œå…± 5 çµ„å‰›å¥½ 200 æª”
    target = all_list[(group_idx-1)*size : group_idx*size]
    
    if not target: return

    print(f"ğŸš€ FinMind æƒæå•Ÿå‹•ï¼šç¬¬ {group_idx} çµ„")
    send_line(f"ğŸ¤– æ­£åœ¨æƒæç¬¬ {group_idx} çµ„è‚¡ç¥¨ (å…± {len(target)} æª”)...")

    hit_list = []
    for s in target:
        try:
            df = get_stock_data(s)
            if df.empty or len(df) < 10:
                continue
            
            curr = df['close'].iloc[-1]
            past_high = df['max'].iloc[-8:-1].max()
            
            # æ¢ä»¶ï¼šæ”¶ç›¤åƒ¹ >= éå» 7 æ—¥æœ€é«˜åƒ¹
            if curr >= past_high:
                name = stock_dict.get(s, "")
                hit_list.append(f"âœ… {s} {name}: {curr:.2f}\n   ğŸ¯ æ”¯æ’: {curr*0.764:.2f}")
            
            print(f"ğŸ” æƒæå®Œæˆ: {s}")
            time.sleep(0.4) # FinMind å…è²»ç‰ˆå»ºè­°ä¼‘æ¯æ™‚é–“
            
        except Exception as e:
            print(f"âŒ {s} å‡ºéŒ¯: {e}")

    if hit_list:
        send_line(f"ğŸš©ã€ç¬¬ {group_idx} çµ„ç¯©é¸å ±å‘Šã€‘\n" + "\n".join(hit_list))
    else:
        send_line(f"ğŸ’¡ ç¬¬ {group_idx} çµ„ä»Šæ—¥ç„¡ç¬¦åˆæ¨™çš„ã€‚")

if __name__ == "__main__":
    main()
