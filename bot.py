import yfinance as yf
import requests
import os
import time
import pandas as pd

# 1. å–å¾—ç’°å¢ƒè¨­å®š
line_token = os.environ.get('LINE_TOKEN')
user_id = os.environ.get('USER_ID')

def get_tw_top_500():
    """
    æä¾›å°ç£è‚¡å¸‚å‰ 500 æª”æ ¸å¿ƒæ¬Šå€¼è‚¡æ¸…å–®
    """
    stocks = [
        "2330","1303","2317","2454","2308","2412","2881","2882","2303","2891","3711",
        "2886","1301","2408","1216","2884","2892","2002","2382","2885",
        "2357","2912","1326","2880","3008","2603","2883","2887","2379","5880",
        "2327","2207","2345","3045","2409","2609","3231","2356","4938","2890",
        "1101","1504","4904","2615","2474","2801","1402","2395","6505","9904",
        "1102","2301","5871","2352","1605","1304","2105","2610","2618","9910",
        "2383","2451","2377","2353","2324","3037","3034","2313","2360","6669",
        "8046","6415","3035","3443","2376","2449","2337","2458","3406","6176",
        "3017","3532","3044","2385","2492","6213","2439","4919","3533","5434",
        "2404","6271","2354","2355","3019","8215","2368","3006","6139","2809",
        "2812","2834","2845","2855","5876","6005","2851","2838","2867","1513",
        "1514","1519","1503","1511","1722","1717","1723","1710","1708","2103",
        "2106","2108","9921","9914","9945","9933","9917","9925","8464","2633",
        "2606","2617","2605","2201","2204","2206","1312","1313","1314","1305",
        "1308","1309","1310","1434","1440","1476","1477","1210","1227","1232",
        "1231","1702","1707","1720","4142","1760","3702","3704","3706","2401",
        "2421","2457","2471","2480","2481","3014","3023","3029","3042","3062",
        "3189","3376","3576","3596","3653","3661","4958","4961","5269","6205",
        "6206","6285","6409","6412","6531","6533","8016","8150","2006","2014",
        "2023","2027","2031","2501","2511","2542","5522","2548","9930","2611",
        "2637","2634","2614","2607","5234","2455","2344","2312","2323","3036",
        "3041","3015","2448","2347","2450","3013","2362","2380","2351","2419",
        "2485","3028","3030","2464","2420","3049","3059","2329","2369","3264",
        "3380","3413","3515","3557","3583","3617","3665","3682","4915","4927",
        "4952","4967","4968","5225","5243","5288","6116","6153","6196","6202",
        "6224","6257","6269","6277","6278","6281","6414","6416","6442","6451",
        "6456","6488","6515","6552","6643","6670","6672","6674","6679","8011",
        "8021","8028","8039","8050","8070","8072","8081","8103","8105","8112",
        "8114","8121","8131","8163","8210","8213","8261","8299","8411","8436",
        "8454","8462","8478","8480","8481","8482","8488","8926","8936","8938",
        "9911","9918","9919","9924","9926","9927","9934","9935","9937","9938",
        "9939","9940","9941","9942","9943","9944","9946","9955","9958","1215",
        "1217","1218","1219","1220","1225","1229","1233","1234","1235","1236",
        "1256","1264","1315","1316","1319","1321","1323","1324","1325","1337",
        "1338","1339","1340","1341","1409","1410","1413","1414","1416","1417",
        "1418","1419","1432","1436","1439","1441","1442","1443","1444","1445",
        "1446","1447","1449","1451","1452","1453","1454","1455","1456","1457",
        "1459","1460","1463","1464","1465","1466","1467","1468","1470","1471",
        "1472","1473","1474","1475","1506","1507","1512","1516","1517","1521",
        "1522","1524","1525","1526","1527","1528","1529","1530","1531","1532",
        "1533","1535","1536","1537","1538","1539","1540","1541","1558","1560",
        "1568","1582","1583","1587","1589","1590","1592","1597","1598","1603",
        "1604","1608","1609","1611","1612","1614","1615","1616","1617","1618",
        "1626","1701","1704","1709","1711","1712","1713","1714","1718","1721",
        "1724","1725","1726","1727","1730","1731","1732","1733","1734","1735",
        "1736","1737","1742","1752","1762","1773","1776","1783","1784","1785",
        "1786","1788","1789","1795","1802","1805","1806","1808","1809","1810",
        "1817","1903","1904","1905","1906","1907","1909","2007","2008","2009",
        "2010","2012","2013","2015","2017","2020","2022","2024","2025","2028",
        "2029","2030","2032","2033","2034","2038","2049","2059","2062","2101"
    ]
    # ä½¿ç”¨ set å»é™¤å¯èƒ½é‡è¤‡çš„ä»£è™Ÿï¼Œç¢ºä¿åªæœ‰ 500 æª”å·¦å³
    unique_stocks = sorted(list(set(stocks)))
    return [s + ".TW" for s in unique_stocks]

def check_stock_and_notify():
    stock_list = get_tw_top_500()
    hit_stocks = []
    
    print(f"ğŸ•µï¸â€â™‚ï¸ å•Ÿå‹•è¶…ç´šåµéŒ¯æƒæ (ç›®æ¨™ï¼š{len(stock_list)} æª”)... ")

    for i, symbol in enumerate(stock_list):
        try:
            # å¢åŠ  retry æ©Ÿåˆ¶ï¼Œé¿å…å–®æ¬¡æŠ“å–å¤±æ•—
            stock = yf.Ticker(symbol)
            df = stock.history(period="10d")
            
            if len(df) < 5: 
                print(f"âš ï¸ {symbol} è³‡æ–™ä¸è¶³ï¼Œè·³é")
                continue

            # ğŸš€ é›™é‡åƒ¹æ ¼åˆ¤æ–·æ³•ï¼š
            # åŒæ™‚æŠ“å–æ­·å²æœ€å¾Œä¸€ç­†æ”¶ç›¤åƒ¹ï¼Œä»¥åŠ Fast Info çš„å³æ™‚æˆäº¤åƒ¹ï¼Œå–æœ€å¤§è€…
            hist_close = df['Close'].iloc[-1]
            try:
                fast_price = stock.fast_info['last_price']
            except:
                fast_price = 0
            
            current_price = max(hist_close, fast_price)
            
            # ğŸš€ åš´è¬¹çš„é«˜é»åˆ¤æ–·ï¼š
            # æ‰¾å‡ºã€Œä¸å«æœ€å¾Œä¸€ç­†ã€çš„å‰é¢å¹¾å¤©æœ€é«˜åƒ¹
            recent_high = df['High'].iloc[:-1].max()

            # ğŸ” å¼·åˆ¶åµéŒ¯å°å‡ºï¼šè®“æˆ‘å€‘çœ‹çœ‹ 1303 çš„æ•¸æ“š
            if "1303" in symbol:
                print(f"--- DEBUG 1303 ---")
                print(f"æ­·å²æœ€å¾Œæ”¶ç›¤: {hist_close}")
                print(f"å³æ™‚ FastInfo åƒ¹æ ¼: {fast_price}")
                print(f"åˆ¤å®šä½¿ç”¨åƒ¹æ ¼: {current_price}")
                print(f"æ¯”å°é«˜é» (é™¤ä»Šæ—¥å¤–): {recent_high}")
                print(f"çµæœ: {'éŒ„å–' if current_price >= recent_high else 'æœªéç·š'}")

            # åˆ¤æ–·æ˜¯å¦å‰µæ–°é«˜ (æˆ–æ˜¯å¹³é«˜é»)
            if current_price >= recent_high:
                magic_number = current_price * 0.764
                hit_stocks.append(f"âœ… {symbol} ({current_price:.1f})\n   ğŸ¯ 0.764: {magic_number:.1f}")
            
            if i % 30 == 0:
                time.sleep(0.5)
                
        except Exception as e:
            print(f"âŒ {symbol} è™•ç†å‡ºéŒ¯: {e}")
            continue

    # 4. ç™¼é€çµæœ
    if hit_stocks:
        total = len(hit_stocks)
        header = f"ğŸš©ã€7æ—¥æ–°é«˜æƒæå ±å‘Šã€‘\næƒæï¼š{len(stock_list)} æª” / ç¬¦åˆï¼š{total} æª”\n"
        for i in range(0, total, 15):
            chunk = hit_stocks[i : i + 15]
            msg = header + "--------------\n" + "\n".join(chunk)
            send_to_line(msg)
            time.sleep(1)
    else:
        send_to_line(f"ä»Šæ—¥æƒæ {len(stock_list)} æª”å®Œç•¢ï¼Œç„¡äººç¬¦åˆ 7 æ—¥æ–°é«˜ã€‚")

def send_to_line(message):
    if not line_token or not user_id:
        print("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° LINE_TOKEN æˆ– USER_ID")
        return
    headers = {"Authorization": f"Bearer {line_token}", "Content-Type": "application/json"}
    payload = {"to": user_id, "messages": [{"type": "text", "text": message}]}
    r = requests.post("https://api.line.me/v2/bot/message/push", headers=headers, json=payload)
    print(f"LINE ç™¼é€ç‹€æ…‹: {r.status_code}")

if __name__ == "__main__":
    check_stock_and_notify()
