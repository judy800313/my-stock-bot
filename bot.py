import yfinance as yf
import requests
import os
import time
import pandas as pd

# å¾ GitHub Secrets è®€å–é‡‘é‘°
line_token = os.environ.get('LINE_TOKEN')
user_id = os.environ.get('USER_ID')

def get_tw_top_500():
    """
    æä¾›å°ç£è‚¡å¸‚ç´„ 500 æª”æ ¸å¿ƒæ¬Šå€¼è‚¡æ¸…å–®
    """
    stocks = [
        "2330","2317","2454","2308","2412","2881","2882","2303","2891","3711",
        "2886","1301","1303","2408","1216","2884","2892","2002","2382","2885",
        "2357","2912","1326","2880","3008","2603","2883","2887","2379","5880",
        "2327","2207","2345","3045","2409","2609","3231","2356","4938","2890",
        "1101","1504","4904","2615","2474","2801","1402","2395","6505","9904",
        "1102","2301","5871","2352","1605","1304","2105","2610","2618","9910",
        "2383","2451","2377","2353","2324","3037","3034","2313","2360","6669",
        "8046","6415","3035","3443","2376","2449","2337","2458","3406","6176",
        "3017","3532","3044","2385","2492","6213","2439","4919","3533","5434",
        "2404","6271","2354","2355","3019","8215","2368","3006","6139","2809",
        "2812","2834","2845","2855","5876","6005","2851","2838","2867","1513",
        "1514","1519","1503","1511","1722","1717","1723","1710","1708","2103",
        "2106","2108","9921","9914","9945","9933","9917","9925","8464","2633",
        "2606","2617","2605","2201","2204","2206","1312","1313","1314","1305",
        "1308","1309","1310","1434","1440","1476","1477","1210","1227","1232",
        "1231","1702","1707","1720","4142","1760","3702","3704","3706","2401",
        "2421","2457","2471","2480","2481","3014","3023","3029","3042","3062",
        "3189","3376","3576","3596","3653","3661","4958","4961","5269","6205",
        "6206","6285","6409","6412","6531","6533","8016","8150","2006","2014",
        "2023","2027","2031","2501","2511","2542","5522","2548","9930","2611",
        "1508","1536","1590","1609","1704","1711","1725","1727","1773","1789",
        "1802","1904","1909","2006","2014","2015","2027","2031","2101","2103",
        "2104","2106","2201","2204","2206","2207","2231","2312","2324","2329",
        "2337","2340","2347","2352","2353","2354","2355","2356","2360","2367",
        "2368","2371","2376","2377","2383","2385","2392","2395","2401","2402",
        "2404","2409","2419","2420","2421","2428","2439","2449","2451","2455",
        "2457","2458","2474","2480","2481","2492","2498","2501","2504","2511",
        "2515","2520","2534","2542","2548","2603","2605","2606","2607","2609",
        "2610","2615","2617","2618","2633","2634","2637","2707","2723","2727",
        "2801","2809","2812","2834","2838","2845","2851","2855","2867","2880",
        "2881","2882","2883","2884","2885","2886","2887","2888","2889","2890",
        "2891","2892","2897","2903","2912","2915","3003","3004","3005","3006",
        "3010","3014","3017","3019","3023","3029","3030","3034","3035","3036",
        "3037","3042","3044","3045","3231","3376","3406","3443","3481","3532",
        "3533","3596","3653","3661","3665","3702","3704","3706","3708","3711",
        "3714","4142","4763","4904","4906","4915","4919","4938","4958","5264",
        "5269","5522","5871","5876","5880","6005","6176","6213","6239","6269",
        "6271","6281","6282","6285","6409","6412","6414","6415","6443","6446",
        "6472","6505","6531","6669","6691","8046","8150","8215","8454","8464",
        "9904","9910","9914","9917","9921","9933","9945"
    ]
    # ä½¿ç”¨ set ç¢ºä¿ä»£è™Ÿä¸é‡è¤‡ä¸¦æ’åº
    unique_stocks = sorted(list(set(stocks)))
    return [s + ".TW" for s in unique_stocks]

def check_stock_and_notify():
    stock_list = get_tw_top_500()
    hit_stocks = []
    
    print(f"ğŸ•µï¸â€â™‚ï¸ é–‹å§‹æƒæå°è‚¡ {len(stock_list)} æª” (7æ—¥æ–°é«˜æ¢ä»¶)... ")

    for i, symbol in enumerate(stock_list):
        try:
            stock = yf.Ticker(symbol)
            # æŠ“å–æœ€è¿‘ 10 å¤©æ­·å²è³‡æ–™ï¼Œauto_adjust é—œé–‰ä»¥å°é½Šçœ‹ç›¤è»Ÿé«”
            df = stock.history(period="10d", auto_adjust=False)
            
            if len(df) < 5: continue

            # ğŸš€ é›™é‡é˜²æ¼æ©Ÿåˆ¶ï¼š
            # åŒæ™‚æª¢æŸ¥ã€Œæ­·å²æ”¶ç›¤ã€èˆ‡ã€Œç•¶å‰å³æ™‚åƒ¹ã€ï¼Œå–æœ€é«˜è€…ï¼Œè§£æ±ºå»¶é²å•é¡Œ
            try:
                realtime_price = stock.fast_info['last_price']
            except:
                realtime_price = 0
                
            current_price = max(df['Close'].iloc[-1], realtime_price)
            
            # å–å¾—ã€Œå‰ 6 å¤©ã€çš„ç›¤ä¸­æœ€é«˜åƒ¹ (ä¸å«ä»Šå¤©)
            # å¦‚æœè³‡æ–™åº«å·²ç¶“åŒ…å«äº†ä»Šå¤©çš„ Highï¼Œæˆ‘å€‘è¦é¿é–‹å®ƒ
            today_date = pd.Timestamp.now(tz='Asia/Taipei').date()
            if df.index[-1].date() >= today_date:
                recent_high = df['High'].iloc[-7:-1].max()
            else:
                recent_high = df['High'].iloc[-6:].max()

            # åˆ¤æ–·æ˜¯å¦å‰µæ–°é«˜
            if current_price >= recent_high:
                magic_number = current_price * 0.764
                hit_stocks.append(f"âœ… {symbol} ({current_price:.1f})\n   ğŸ¯ 0.764: {magic_number:.1f}")
            
            # æ•ˆèƒ½èª¿ç¯€ï¼šæ¯æƒæ 25 æª”ä¼‘æ¯ 0.5 ç§’ï¼Œé¿å…è¢«å°é–
            if i % 25 == 0:
                time.sleep(0.5)
                
        except Exception:
            continue

    # 4. ç™¼é€çµæœ (æ¯ 15 æª”åˆ‡æˆä¸€å‰‡ LINE è¨Šæ¯)
    if hit_stocks:
        header = f"ğŸš©ã€7æ—¥æ–°é«˜å ±å‘Šã€‘\næƒæï¼š{len(stock_list)} æª” / ç¬¦åˆï¼š{len(hit_stocks)} æª”\n"
        for i in range(0, len(hit_stocks), 15):
            chunk = hit_stocks[i : i + 15]
            msg = header + "--------------\n" + "\n".join(chunk)
            send_to_line(msg)
            time.sleep(1) # è¨Šæ¯é–“éš”ï¼Œé¿å… LINE å®˜æ–¹æ“‹è¨Šæ¯
    else:
        send_to_line(f"ä»Šæ—¥æƒæ {len(stock_list)} æª”å®Œç•¢ï¼Œç„¡äººç¬¦åˆ 7 æ—¥æ–°é«˜ã€‚")

def send_to_line(message):
    if not line_token or not user_id:
        print("Error: Missing LINE_TOKEN or USER_ID")
        return
    headers = {"Authorization": f"Bearer {line_token}", "Content-Type": "application/json"}
    payload = {"to": user_id, "messages": [{"type": "text", "text": message}]}
    requests.post("https://api.line.me/v2/bot/message/push", headers=headers, json=payload)

if __name__ == "__main__":
    check_stock_and_notify()
