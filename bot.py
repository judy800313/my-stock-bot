import yfinance as yf
import pandas as pd
import requests
import os
import time
import sys

LINE_TOKEN = os.getenv('LINE_TOKEN')
USER_ID = os.getenv('USER_ID')

def get_all_stocks():
    # é€™è£¡å¯ä»¥æ”¾å…¥ 200 æª”è‚¡ç¥¨ä»£ç¢¼ï¼Œç›®å‰æˆ‘å…ˆæ”¾å…¥ä½ ä¹‹å‰çš„æ¸…å–®ï¼Œè«‹è‡ªè¡Œåœ¨ä¸‹æ–¹è£œå……
    all_list = [
        # --- åŸå§‹æ¸…å–®èˆ‡æ¬Šå€¼è‚¡ ---
        "1101","1102","1210","1216","1301","1303","1319","1326","1402","1476",
        "1503","1504","1513","1519","1560","1590","1605","1717","1722","1723",
        "2002","2301","2303","2308","2317","2330","2337","2352","2357","2382",
        "2409","2412","2454","2603","2609","2610","2618","2881","2882","3008",
        "3037","3231","3481","4938","5871","6505","9904","2449","2451","3034",
        "3035","3711","6415",
        # --- æ“´å±•è‡³ 200 æª” (åŠå°é«”èˆ‡é›»å­è¨­å‚™) ---
        "2344","2360","2376","2377","2379","2383","2385","2408","2439","2458",
        "3006","3017","3023","3036","3044","3189","3227","3406","3443","3532",
        "3533","3583","3653","3661","4739","4919","4958","4961","4967","4968",
        "5234","5269","5274","6176","6205","6213","6239","6271","6414","6446",
        "6472","6510","6515","6531","6533","6643","6669","6719","6770","6805",
        # --- é‡‘èã€èˆªé‹èˆ‡å‚³ç”¢è£œå…… ---
        "2605","2606","2615","2633","2634","2637","2801","2809","2812","2834",
        "2880","2883","2884","2885","2886","2887","2888","2889","2890","2891",
        "2892","2897","5876","5880","6005","9910","9914","9917","9921","9933",
        "9941","9945","1103","1304","1305","1308","1310","1312","1314","1434",
        "1440","1444","1477","1514","1522","1536","1707","1710","1711","1720",
        "1802","1904","2006","2014","2023","2027","2101","2103","2105","2106",
        "2201","2204","2206","2312","2313","2323","2324","2340","2345","2347",
        "2351","2353","2354","2355","2356","2367","2368","2371","2392","2393",
        "2401","2404","2419","2421","2455","2474","2480","2492","2498","2501",
        "2504","2511","2542","2548","2607","2707","2723","2727","2903","2912"
    ]
    # è‡ªå‹•å»é‡ã€æ’åºä¸¦åŠ ä¸Š .TW
    return sorted(list(set([s + ".TW" for s in all_list])))

def run_scanner(group_idx):
    all_stocks = get_all_stocks()
    size = 50 
    start = (group_idx - 1) * size
    end = group_idx * size
    target_stocks = all_stocks[start:end]
    
    if not target_stocks:
        print(f"ğŸ’¡ ç¬¬ {group_idx} çµ„ç›®å‰æ²’æœ‰è‚¡ç¥¨ã€‚")
        return

    hit_list = []
    print(f"ğŸš€ [200æª”è¨ˆç•«] æ­£åœ¨æƒæç¬¬ {group_idx} çµ„ ({len(target_stocks)} æª”)...")

    for symbol in target_stocks:
        try:
            stock = yf.Ticker(symbol)
            df = stock.history(period="15d")
            if len(df) < 10: continue

            curr_price = float(df['Close'].iloc[-1])
            past_high = float(df['High'].iloc[-8:-1].max())

            if curr_price >= past_high:
                support = curr_price * 0.764
                hit_list.append(f"âœ… {symbol} ({curr_price:.2f})\n   ğŸ¯ æ”¯æ’ 0.764: {support:.2f}")
            
            time.sleep(0.8) # æ¯å€‹è«‹æ±‚é–“éš”ï¼Œé€™å° 200 æª”éå¸¸é‡è¦
        except Exception as e:
            print(f"âš ï¸ {symbol} æŠ“å–è·³é: {e}")

    if hit_list:
        msg = f"ğŸš©ã€å°è‚¡å ±å‘Š-ç¬¬ {group_idx} çµ„ã€‘\n----------------\n" + "\n".join(hit_list)
        send_to_line(msg)
    else:
        print(f"ğŸ’¡ ç¬¬ {group_idx} çµ„æƒæå®Œç•¢ï¼Œç„¡ç¬¦åˆæ¢ä»¶è‚¡ç¥¨ã€‚")

def send_to_line(msg):
    if not LINE_TOKEN or not USER_ID: return
    url = "https://api.line.me/v2/bot/message/push"
    headers = {"Authorization": f"Bearer {LINE_TOKEN}", "Content-Type": "application/json"}
    payload = {"to": USER_ID, "messages": [{"type": "text", "text": msg}]}
    requests.post(url, headers=headers, json=payload)

if __name__ == "__main__":
    idx = int(sys.argv[1]) if len(sys.argv) > 1 else 1
    run_scanner(idx)
